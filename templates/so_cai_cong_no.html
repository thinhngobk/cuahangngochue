{% extends 'base.html' %}
{% load humanize %}

{% block extra_css %}
<style>
    [x-cloak] {
        display: none !important;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .ledger-row-tang {
        background-color: #fef2f2;
    }

    .ledger-row-giam {
        background-color: #f0fdf4;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen" x-data="ledgerManager()" x-init="init()" x-cloak>
    <div class="w-full px-4 py-6 space-y-6">

        <!-- HEADER -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <a href="/"
                        class="text-xs font-bold text-white/80 uppercase mb-2 block hover:text-white transition">â† Trang
                        chá»§</a>
                    <h1 class="text-3xl font-black text-white tracking-tight">ğŸ“’ Sá»” CÃI CÃ”NG Ná»¢</h1>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 px-6 border border-white/30">
                    <div class="text-[10px] uppercase font-black text-white/80 tracking-wider mb-1">DÆ° ná»£ cuá»‘i ká»³</div>
                    <div class="text-3xl font-black text-white">
                        {{ du_no_cuoi_ky|intcomma|default:"0" }}â‚«
                    </div>
                </div>
            </div>
        </div>

        <!-- FILTER BAR -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-blue-100 p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- KHÃCH HÃ€NG - Search vá»›i Alpine -->
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">
                        ğŸ‘¤ KhÃ¡ch hÃ ng *
                    </label>

                    <input type="text" 
                        x-model="customerSearch" 
                        @input="searchCustomers()"
                        @focus="searchCustomers()"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none font-semibold"
                        placeholder="TÃ¬m tÃªn hoáº·c SÄT..."
                        autocomplete="off">

                    <!-- Dropdown káº¿t quáº£ -->
                    <div x-show="customerResults.length > 0"
                        @click.away="customerResults = []"
                        class="absolute w-full left-0 top-full z-50 bg-white border-2 border-blue-200 shadow-2xl rounded-2xl mt-2 max-h-80 overflow-y-auto custom-scrollbar">

                        <template x-for="kh in customerResults" :key="kh.id">
                            <div @click="selectCustomer(kh)"
                                class="p-3 hover:bg-blue-50 cursor-pointer border-b flex justify-between items-center transition-colors">
                                <div>
                                    <div class="font-bold text-sm" x-text="kh.ten"></div>
                                    <div class="text-xs text-slate-400" x-text="kh.ma"></div>
                                </div>
                                <div class="text-xs text-slate-500" x-text="kh.sdt || '-'"></div>
                            </div>
                        </template>
                    </div>

                    <!-- Hiá»ƒn thá»‹ khÃ¡ch Ä‘Ã£ chá»n -->
                    <div x-show="selectedCustomerId && !customerResults.length" 
                        class="mt-2 text-xs text-blue-600 font-semibold">
                        âœ“ ÄÃ£ chá»n: <span x-text="customerSearch"></span>
                    </div>
                </div>

                <!-- Tá»ª NGÃ€Y -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ğŸ“… Tá»« ngÃ y</label>
                    <input type="date" x-model="fromDate"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none font-semibold">
                </div>

                <!-- Äáº¾N NGÃ€Y -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ğŸ“… Äáº¿n ngÃ y</label>
                    <input type="date" x-model="toDate"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none font-semibold">
                </div>

                <!-- NÃšT Lá»ŒC -->
                <div class="flex items-end">
                    <button @click="filter()"
                        class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition-all uppercase text-sm">
                        ğŸ” Xem sá»•
                    </button>
                </div>
            </div>
        </div>

        <!-- Äá»I CHIáº¾U (Náº¿u cÃ³) -->
        {% if audit %}
        <div class="bg-white rounded-2xl shadow-lg border-2 {% if audit.khop %}border-green-200{% else %}border-red-200{% endif %} p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 {% if audit.khop %}bg-green-100{% else %}bg-red-100{% endif %} rounded-full flex items-center justify-center mr-3">
                    <span class="text-2xl">{% if audit.khop %}âœ…{% else %}âš ï¸{% endif %}</span>
                </div>
                <h3 class="text-xl font-black text-slate-800 uppercase">
                    {% if audit.khop %}Äá»‘i chiáº¿u khá»›p{% else %}ChÃªnh lá»‡ch phÃ¡t hiá»‡n{% endif %}
                </h3>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-50 rounded-xl p-4">
                    <div class="text-xs text-slate-500 font-bold">Ná»£ Ä‘áº§u ká»³</div>
                    <div class="text-lg font-black text-slate-800">{{ audit.no_dau_ky|intcomma }}â‚«</div>
                </div>
                <div class="bg-blue-50 rounded-xl p-4">
                    <div class="text-xs text-blue-600 font-bold">Tá»•ng hÃ³a Ä‘Æ¡n</div>
                    <div class="text-lg font-black text-blue-700">{{ audit.tong_hd|intcomma }}â‚«</div>
                </div>
                <div class="bg-green-50 rounded-xl p-4">
                    <div class="text-xs text-green-600 font-bold">Tá»•ng thu</div>
                    <div class="text-lg font-black text-green-700">{{ audit.tong_pt|intcomma }}â‚«</div>
                </div>
                <div class="bg-amber-50 rounded-xl p-4">
                    <div class="text-xs text-amber-600 font-bold">Tá»•ng hoÃ n</div>
                    <div class="text-lg font-black text-amber-700">{{ audit.tong_hh|intcomma }}â‚«</div>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-3 gap-4">
                <div class="bg-slate-100 rounded-xl p-4">
                    <div class="text-xs text-slate-500 font-bold">DÆ° ná»£ sá»• cÃ¡i</div>
                    <div class="text-xl font-black text-slate-800">{{ audit.du_no_so_cai|intcomma }}â‚«</div>
                </div>
                <div class="bg-slate-100 rounded-xl p-4">
                    <div class="text-xs text-slate-500 font-bold">DÆ° ná»£ chá»©ng tá»«</div>
                    <div class="text-xl font-black text-slate-800">{{ audit.du_no_chung_tu|intcomma }}â‚«</div>
                </div>
                <div class="{% if audit.khop %}bg-green-100{% else %}bg-red-100{% endif %} rounded-xl p-4">
                    <div class="text-xs {% if audit.khop %}text-green-600{% else %}text-red-600{% endif %} font-bold">ChÃªnh lá»‡ch</div>
                    <div class="text-xl font-black {% if audit.khop %}text-green-700{% else %}text-red-700{% endif %}">
                        {{ audit.chenh_lech|intcomma }}â‚«
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tá»”NG Há»¢P -->
        {% if khach_hang_id %}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl shadow-lg border-2 border-slate-200 p-6">
                <div class="text-xs font-bold text-slate-400 uppercase mb-2">DÆ° ná»£ Ä‘áº§u ká»³</div>
                <div class="text-2xl font-black text-slate-700">{{ du_no_dau_ky|intcomma }}â‚«</div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg border-2 border-red-200 p-6">
                <div class="text-xs font-bold text-red-400 uppercase mb-2">ğŸ“ˆ Tá»•ng tÄƒng</div>
                <div class="text-2xl font-black text-red-600">{{ tong_tang|intcomma }}â‚«</div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg border-2 border-green-200 p-6">
                <div class="text-xs font-bold text-green-400 uppercase mb-2">ğŸ“‰ Tá»•ng giáº£m</div>
                <div class="text-2xl font-black text-green-600">{{ tong_giam|intcomma }}â‚«</div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg border-2 border-blue-200 p-6">
                <div class="text-xs font-bold text-blue-400 uppercase mb-2">DÆ° ná»£ cuá»‘i ká»³</div>
                <div class="text-2xl font-black text-blue-600">{{ du_no_cuoi_ky|intcomma }}â‚«</div>
            </div>
        </div>
        {% endif %}

        <!-- TABLE -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-blue-100 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-slate-800 to-blue-900 text-white">
                        <tr>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">ğŸ“… NgÃ y</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">ğŸ·ï¸ Chá»©ng tá»«</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">ğŸ“ Diá»…n giáº£i</th>
                            <th class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider">ğŸ“ˆ TÄƒng</th>
                            <th class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider">ğŸ“‰ Giáº£m</th>
                            <th class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider">ğŸ’° DÆ° ná»£</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">ğŸ“‹ Ghi chÃº</th>
                            <th class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider">ğŸ‘¤ NgÆ°á»i táº¡o</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        {% if khach_hang_id %}
                            <!-- DÃ²ng Ä‘áº§u ká»³ -->
                            <tr class="bg-slate-100 font-bold">
                                <td class="px-4 py-4">---</td>
                                <td class="px-4 py-4">Äáº§u ká»³</td>
                                <td class="px-4 py-4">Sá»‘ dÆ° ná»£ Ä‘áº§u ká»³</td>
                                <td class="px-4 py-4 text-right">---</td>
                                <td class="px-4 py-4 text-right">---</td>
                                <td class="px-4 py-4 text-right text-blue-600 text-lg font-black">{{ du_no_dau_ky|intcomma }}â‚«</td>
                                <td class="px-4 py-4"></td>
                                <td class="px-4 py-4 text-center">---</td>
                            </tr>

                            {% for item in so_cai_list %}
                            <tr class="hover:bg-blue-50 transition-colors {% if item.tang > 0 %}ledger-row-tang{% elif item.giam > 0 %}ledger-row-giam{% endif %}">
                                <td class="px-4 py-4">
                                    <div class="text-sm font-semibold">{{ item.ngay_ghi_so|date:"d/m/Y" }}</div>
                                    <div class="text-xs text-slate-400">{{ item.ngay_ghi_so|date:"H:i" }}</div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="font-bold text-blue-600">{{ item.ma_chung_tu }}</div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-sm text-slate-700">{{ item.dien_giai }}</div>
                                </td>
                                <td class="px-4 py-4 text-right">
                                    {% if item.tang > 0 %}
                                    <div class="text-lg font-black text-red-600">{{ item.tang|intcomma }}â‚«</div>
                                    {% else %}
                                    <div class="text-slate-300">---</div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-right">
                                    {% if item.giam > 0 %}
                                    <div class="text-lg font-black text-green-600">{{ item.giam|intcomma }}â‚«</div>
                                    {% else %}
                                    <div class="text-slate-300">---</div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-4 text-right">
                                    <div class="text-lg font-black text-blue-600">{{ item.du_no_tuc_thoi|intcomma }}â‚«</div>
                                </td>
                                <td class="px-4 py-4">
                                    <input type="text" 
                                        value="{{ item.ghichu }}"
                                        @blur="updateNote($event.target, {{ item.id }})"
                                        class="w-full px-2 py-1 border border-slate-200 rounded text-sm focus:border-blue-500 outline-none"
                                        placeholder="Nháº­p ghi chÃº...">
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <div class="text-xs font-semibold text-slate-600">{{ item.user.username|default:"---" }}</div>
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- DÃ²ng tá»•ng -->
                            <tr class="bg-blue-50 font-black text-lg">
                                <td colspan="3" class="px-4 py-4 text-right uppercase">Tá»”NG Cá»˜NG:</td>
                                <td class="px-4 py-4 text-right text-red-600">{{ tong_tang|intcomma }}â‚«</td>
                                <td class="px-4 py-4 text-right text-green-600">{{ tong_giam|intcomma }}â‚«</td>
                                <td class="px-4 py-4 text-right text-blue-600">{{ du_no_cuoi_ky|intcomma }}â‚«</td>
                                <td colspan="2"></td>
                            </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="p-24 text-center">
                                <div class="text-6xl mb-4">ğŸ“’</div>
                                <div class="text-xl font-bold text-slate-400">Vui lÃ²ng chá»n khÃ¡ch hÃ ng Ä‘á»ƒ xem sá»• cÃ¡i</div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function ledgerManager() {
    return {
        customerSearch: '{{ selected_customer.tenkhachhang|default:""|escapejs }}',
        selectedCustomerId: '{{ khach_hang_id|default:"" }}',
        customerResults: [],
        customerTimeout: null,
        fromDate: '{{ tu_ngay|default:"" }}',
        toDate: '{{ den_ngay|default:"" }}',
        
        init() {
            console.log('Ledger manager initialized');
        },
        
        searchCustomers() {
            clearTimeout(this.customerTimeout);
            
            if (this.customerSearch.length < 2) {
                this.customerResults = [];
                return;
            }
            
            this.customerTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/search-customers/?q=${encodeURIComponent(this.customerSearch)}`);
                    const data = await res.json();
                    this.customerResults = data;
                } catch (e) {
                    console.error('Search error:', e);
                    this.customerResults = [];
                }
            }, 300);
        },
        
        selectCustomer(kh) {
            this.selectedCustomerId = kh.id;
            this.customerSearch = kh.ten;
            this.customerResults = [];
        },
        
        filter() {
            if (!this.selectedCustomerId) {
                alert('Vui lÃ²ng chá»n khÃ¡ch hÃ ng!');
                return;
            }
            
            const params = new URLSearchParams();
            params.append('khach_hang_id', this.selectedCustomerId);
            if (this.fromDate) params.append('tu_ngay', this.fromDate);
            if (this.toDate) params.append('den_ngay', this.toDate);
            
            window.location.href = '?' + params.toString();
        },
        
        async updateNote(input, itemId) {
            const newNote = input.value.trim();
            
            try {
                const response = await fetch('/api/update-ghi-chu-so-cai/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        id: itemId,
                        ghi_chu: newNote
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    input.classList.add('border-green-500');
                    setTimeout(() => {
                        input.classList.remove('border-green-500');
                    }, 1000);
                } else {
                    alert('Lá»—i: ' + result.message);
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Lá»—i káº¿t ná»‘i!');
            }
        },
        
        getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return decodeURIComponent(value);
                }
            }
            return '';
        }
    }
}
</script>
{% endblock %}