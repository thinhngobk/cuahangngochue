{% extends 'base.html' %}
{% load humanize %}

{% block extra_css %}
<style>
    [x-cloak] {
        display: none !important;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .row-canceled {
        opacity: 0.5;
        background-color: #fef2f2;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen" x-data="receiptManager()" x-init="init()" x-cloak>
    <div class="w-full px-4 py-6 space-y-6">

        <!-- HEADER -->
        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-6 shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <a href="/"
                        class="text-xs font-bold text-white/80 uppercase mb-2 block hover:text-white transition">‚Üê Trang
                        ch·ªß</a>
                    <h1 class="text-3xl font-black text-white tracking-tight">üí∞ PHI·∫æU THU</h1>
                    <div class="flex gap-4 text-white text-sm font-bold mt-3">
                        <div class="bg-white/20 px-4 py-2 rounded-lg">
                            T·ªïng: <span class="text-2xl font-black" x-text="allReceipts.length"></span>
                        </div>
                        <div class="bg-green-500/30 px-4 py-2 rounded-lg">
                            ƒê√£ duy·ªát: <span class="text-2xl font-black" x-text="approvedCount"></span>
                        </div>
                        <div class="bg-amber-500/30 px-4 py-2 rounded-lg">
                            Ch·ªù duy·ªát: <span class="text-2xl font-black" x-text="pendingCount"></span>
                        </div>
                    </div>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 px-6 border border-white/30 min-w-[200px]">
                    <div class="text-[10px] uppercase font-black text-white/80 tracking-wider mb-1">T·ªïng thu (ƒë√£ l·ªçc)
                    </div>
                    <div class="text-3xl font-black text-white" x-text="formatVND(tongThu)"></div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex gap-2 mb-4">
            <button @click="filterStatus = 'all'"
                :class="filterStatus === 'all' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600'"
                class="px-4 py-2 rounded-lg font-bold transition-all">
                T·∫•t c·∫£ (<span x-text="allReceipts.length"></span>)
            </button>
            <button @click="filterStatus = 'approved'"
                :class="filterStatus === 'approved' ? 'bg-green-600 text-white' : 'bg-white text-slate-600'"
                class="px-4 py-2 rounded-lg font-bold transition-all">
                ƒê√£ duy·ªát (<span x-text="approvedCount"></span>)
            </button>
            <button @click="filterStatus = 'pending'"
                :class="filterStatus === 'pending' ? 'bg-amber-600 text-white' : 'bg-white text-slate-600'"
                class="px-4 py-2 rounded-lg font-bold transition-all">
                Ch·ªù duy·ªát (<span x-text="pendingCount"></span>)
            </button>
            <button @click="filterStatus = 'canceled'"
                :class="filterStatus === 'canceled' ? 'bg-red-600 text-white' : 'bg-white text-slate-600'"
                class="px-4 py-2 rounded-lg font-bold transition-all">
                ƒê√£ h·ªßy (<span x-text="canceledCount"></span>)
            </button>
        </div>

        <!-- FILTER BAR -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-100 p-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üîç T√¨m ki·∫øm</label>
                    <input type="text" x-model="searchQuery"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-emerald-500 outline-none font-semibold"
                        placeholder="T√¨m kh√°ch h√†ng, m√£ phi·∫øu...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìÖ T·ª´ ng√†y</label>
                    <input type="date" x-model="fromDate"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-emerald-500 outline-none font-semibold">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìÖ ƒê·∫øn ng√†y</label>
                    <input type="date" x-model="toDate"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-emerald-500 outline-none font-semibold">
                </div>

                <div class="flex items-end gap-2">
                    <button @click="filter()"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition-all uppercase text-sm">
                        L·ªçc
                    </button>
                    <button @click="showAddModal = true"
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition-all text-lg">
                        ‚ûï
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-100 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-slate-800 to-emerald-900 text-white">
                        <tr>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üè∑Ô∏è M√£ phi·∫øu
                            </th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üìÖ Ng√†y l·∫≠p</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üë§ Kh√°ch h√†ng
                            </th>
                            <th class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider">üí∞ S·ªë ti·ªÅn</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üí≥ H√¨nh th·ª©c
                            </th>
                            <th class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider">üìä Tr·∫°ng th√°i
                            </th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üìù Ghi ch√∫</th>
                            <th class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider">‚öôÔ∏è Thao t√°c
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        <template x-for="r in filteredReceipts" :key="r.id">
                            <tr class="hover:bg-emerald-50 transition-colors"
                                :class="{'row-canceled': r.trang_thai === 'canceled'}">
                                <td class="px-4 py-4">
                                    <div class="font-bold text-emerald-600" x-text="'#' + r.ma"></div>
                                    <div class="text-xs text-amber-600 mt-1" x-show="r.hoadon"
                                        x-text="'üîó Hƒê: ' + r.hoadon"></div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-sm font-semibold" x-text="r.ngay_display"></div>
                                    <div class="text-xs text-slate-400" x-text="r.gio_display"></div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="font-bold text-slate-800" x-text="r.khachhang"></div>
                                    <div class="text-xs text-slate-400" x-show="r.sdt" x-text="'üìû ' + r.sdt"></div>
                                </td>
                                <td class="px-4 py-4 text-right">
                                    <div class="text-lg font-black text-emerald-600" x-text="formatVND(r.sotien)">
                                    </div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-sm font-semibold" x-text="r.hinhthuc"></div>
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <span x-show="r.is_approved"
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-black bg-green-100 text-green-800">
                                        ‚úÖ ƒê√£ duy·ªát
                                    </span>
                                    <span x-show="!r.is_approved && r.trang_thai !== 'canceled'"
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-black bg-amber-100 text-amber-800">
                                        ‚è≥ Ch·ªù duy·ªát
                                    </span>
                                    <span x-show="r.trang_thai === 'canceled'"
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-black bg-red-100 text-red-800">
                                        ‚ùå ƒê√£ h·ªßy
                                    </span>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-sm text-slate-600 max-w-xs truncate" x-text="r.ghichu || '-'">
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <div class="flex gap-2 justify-center flex-wrap">
                                        <!-- N√∫t Duy·ªát - CH·ªà HI·ªÜN KHI PENDING -->
                                        <button
                                            @click="approveReceipt(r.id)"
                                            x-show="!r.is_approved && r.trang_thai !== 'canceled'"
                                            class="px-3 py-1 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition text-xs font-bold flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Duy·ªát
                                        </button>

                                        <!-- N√∫t S·ª≠a - CH·ªà HI·ªÜN KHI PENDING -->
                                        <button
                                            @click="editReceipt(r.id, r.khachhang_id, r.sotien, r.ghichu, r.hinhthuc)"
                                            x-show="!r.is_approved && r.trang_thai !== 'canceled'"
                                            class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-xs font-bold flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            S·ª≠a
                                        </button>

                                        <!-- N√∫t H·ªßy - CH·ªà HI·ªÜN KHI PENDING -->
                                        <button
                                            @click="cancelReceipt(r.id)"
                                            x-show="!r.is_approved && r.trang_thai !== 'canceled'"
                                            class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-xs font-bold flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                            H·ªßy
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <template x-if="filteredReceipts.length === 0">
                            <tr>
                                <td colspan="8" class="px-4 py-8 text-center text-slate-400 font-semibold">
                                    Kh√¥ng c√≥ phi·∫øu thu n√†o
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT MODAL -->
    <div x-show="showAddModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
        @click.self="showAddModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6" @click.stop>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-slate-800"
                    x-text="editingId ? '‚úèÔ∏è S·ª¨A PHI·∫æU THU' : '‚ûï TH√äM PHI·∫æU THU'"></h2>
                <button @click="showAddModal = false" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form @submit.prevent="submitForm" class="space-y-4">
                <!-- Customer Search -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üë§ Kh√°ch h√†ng *</label>
                    <div class="relative">
                        <input type="text" x-model="customerSearch" @input="searchCustomersInModal()"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-semibold"
                            placeholder="T√¨m kh√°ch h√†ng..." autocomplete="off">

                        <div x-show="customerResults.length > 0"
                            class="absolute z-10 w-full mt-1 bg-white border-2 border-slate-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                            <template x-for="kh in customerResults" :key="kh.id">
                                <div @click="selectCustomer(kh)"
                                    class="px-4 py-3 hover:bg-emerald-50 cursor-pointer border-b border-slate-100">
                                    <div class="font-bold text-slate-800" x-text="kh.ten"></div>
                                    <div class="text-xs text-slate-400" x-text="kh.sdt"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Amount -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üí∞ S·ªë ti·ªÅn *</label>
                    <input type="text" x-model="formData.so_tien_display" @input="updateAmount($event.target.value)"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-semibold"
                        placeholder="0">
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üí≥ H√¨nh th·ª©c</label>
                    <select x-model="formData.hinh_thuc"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-semibold">
                        <option>Ti·ªÅn m·∫∑t</option>
                        <option>Chuy·ªÉn kho·∫£n</option>
                        <option>Qu·∫πt th·∫ª</option>
                    </select>
                </div>

                <!-- Note -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìù Ghi ch√∫</label>
                    <textarea x-model="formData.ghi_chu" rows="3"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none font-semibold"
                        placeholder="Ghi ch√∫..."></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-4">
                    <button type="button" @click="showAddModal = false"
                        class="flex-1 px-6 py-3 bg-slate-200 text-slate-700 font-black rounded-xl hover:bg-slate-300 transition">
                        H·ªßy
                    </button>
                    <button type="submit" :disabled="isSubmitting"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-black rounded-xl hover:shadow-lg transition"
                        :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                        <span x-text="isSubmitting ? 'ƒêang l∆∞u...' : (editingId ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi')"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function receiptManager() {
        return {
            // Data from Django
            allReceipts: [
                {% for p in phieu_thu_list %}
                {
                    id: {{ p.id }},
                    ma: "{{ p.maphieuthu }}",
                    hoadon: "{{ p.mahoadon|default:'' }}",
                    ngay_display: "{{ p.ngaylap|date:'d/m/Y' }}",
                    gio_display: "{{ p.ngaylap|date:'H:i' }}",
                    khachhang: "{{ p.khachhang.tenkhachhang }}",
                    khachhang_id: {{ p.khachhang.id }},
                    sdt: "{{ p.khachhang.sdt|default:'' }}",
                    sotien: {{ p.sotienthu }},
                    hinhthuc: "{{ p.hinhthucthanhtoan }}",
                    is_approved: {% if p.trang_thai_duyet == 'approved' %}true{% else %}false{% endif %},
                    trang_thai: "{{ p.trang_thai_duyet }}",
                    ghichu: "{{ p.ghichu|default:'' }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],

            // Filter state
            filterStatus: 'all',
            searchQuery: '',
            fromDate: '',
            toDate: '',

            // Modal state
            showAddModal: false,
            editingId: null,
            isSubmitting: false,

            // Form data
            formData: {
                khachhang_id: '',
                so_tien: '',
                so_tien_display: '',
                hinh_thuc: 'Ti·ªÅn m·∫∑t',
                ghi_chu: ''
            },

            // Customer search
            customerSearch: '',
            customerResults: [],
            customerTimeout: null,

            // Computed: S·ªë l∆∞·ª£ng ƒë√£ duy·ªát
            get approvedCount() {
                return this.allReceipts.filter(r => r.is_approved).length;
            },

            // Computed: S·ªë l∆∞·ª£ng ƒë√£ h·ªßy
            get canceledCount() {
                return this.allReceipts.filter(r => r.trang_thai === 'canceled').length;
            },

            // Computed: S·ªë l∆∞·ª£ng ch·ªù duy·ªát
            get pendingCount() {
                return this.allReceipts.filter(r => !r.is_approved && r.trang_thai !== 'canceled').length;
            },

            // Computed: T·ªïng ti·ªÅn c·ªßa filtered receipts
            get tongThu() {
                return this.filteredReceipts.reduce((sum, r) => sum + r.sotien, 0);
            },

            // Computed: Filtered receipts
            get filteredReceipts() {
                let filtered = this.allReceipts;

                // Filter by status
                if (this.filterStatus === 'approved') {
                    filtered = filtered.filter(r => r.is_approved);
                } else if (this.filterStatus === 'pending') {
                    filtered = filtered.filter(r => !r.is_approved && r.trang_thai !== 'canceled');
                } else if (this.filterStatus === 'canceled') {
                    filtered = filtered.filter(r => r.trang_thai === 'canceled');
                }

                // Filter by search
                if (this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(r =>
                        r.ma.toLowerCase().includes(q) ||
                        r.khachhang.toLowerCase().includes(q)
                    );
                }

                return filtered;
            },

            searchCustomersInModal() {
                clearTimeout(this.customerTimeout);

                if (this.customerSearch.length < 2) {
                    this.customerResults = [];
                    return;
                }

                this.customerTimeout = setTimeout(async () => {
                    try {
                        const res = await fetch(`/api/search-customers/?q=${encodeURIComponent(this.customerSearch)}`);
                        this.customerResults = await res.json();
                    } catch (e) {
                        console.error('Search error:', e);
                        this.customerResults = [];
                    }
                }, 300);
            },

            selectCustomer(kh) {
                this.formData.khachhang_id = kh.id;
                this.customerSearch = kh.ten;
                this.customerResults = [];
            },

            updateAmount(value) {
                const num = value.replace(/[^0-9]/g, '');
                this.formData.so_tien = num;
                this.formData.so_tien_display = this.formatNumber(num);
            },

            async submitForm() {
                if (this.isSubmitting) {
                    console.log('ƒêang submit, b·ªè qua');
                    return;
                }

                // Validate
                if (!this.formData.khachhang_id) {
                    alert("‚ùå Vui l√≤ng ch·ªçn kh√°ch h√†ng!");
                    return;
                }

                if (!this.formData.so_tien || parseFloat(this.formData.so_tien) <= 0) {
                    alert("‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn!");
                    return;
                }

                this.isSubmitting = true;

                try {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', this.getCSRFToken());
                    formData.append('khachhang_id', this.formData.khachhang_id);
                    formData.append('so_tien', this.formData.so_tien);
                    formData.append('hinh_thuc', this.formData.hinh_thuc);
                    formData.append('ghi_chu', this.formData.ghi_chu);

                    if (this.editingId) {
                        formData.append('phieu_id', this.editingId);
                    }

                    const response = await fetch('{% url "luu_phieu_thu_nhanh" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        alert(result.message);
                        this.showAddModal = false;
                        window.location.reload();
                    } else {
                        alert(result.message || '‚ùå C√≥ l·ªói x·∫£y ra');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    alert('‚ùå L·ªói k·∫øt n·ªëi!');
                } finally {
                    this.isSubmitting = false;
                }
            },

            editReceipt(id, khId, soTien, ghiChu, hinhThuc) {
                this.editingId = id;
                this.formData = {
                    khachhang_id: khId,
                    so_tien: soTien,
                    so_tien_display: this.formatNumber(soTien),
                    hinh_thuc: hinhThuc || 'Ti·ªÅn m·∫∑t',
                    ghi_chu: ghiChu || ''
                };
                this.customerSearch = '';
                this.showAddModal = true;
            },

            async approveReceipt(id) {
                if (!confirm('X√°c nh·∫≠n DUY·ªÜT phi·∫øu thu n√†y?\n\n‚úÖ S·∫Ω ghi gi·∫£m n·ª£ kh√°ch h√†ng')) {
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', this.getCSRFToken());

                    const response = await fetch(`/duyet-phieu-thu/${id}/`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        alert('‚úÖ ' + result.message);
                        window.location.reload();
                    } else {
                        alert('‚ùå ' + (result.message || 'C√≥ l·ªói x·∫£y ra'));
                    }
                } catch (error) {
                    console.error('Approve error:', error);
                    alert('‚ùå L·ªói k·∫øt n·ªëi!');
                }
            },

            async cancelReceipt(id) {
                if (!confirm('X√°c nh·∫≠n H·ª¶Y phi·∫øu thu n√†y?\n\n‚ö†Ô∏è Ch·ªâ h·ªßy ƒë∆∞·ª£c khi ƒëang ch·ªù duy·ªát')) {
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', this.getCSRFToken());

                    const response = await fetch(`/huy-phieu-thu/${id}/`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        alert('‚úÖ ' + result.message);
                        window.location.reload();
                    } else {
                        alert('‚ùå ' + (result.message || 'C√≥ l·ªói x·∫£y ra'));
                    }
                } catch (error) {
                    console.error('Cancel error:', error);
                    alert('‚ùå L·ªói k·∫øt n·ªëi!');
                }
            },

            filter() {
                const params = new URLSearchParams();
                if (this.searchQuery) params.append('search', this.searchQuery);
                if (this.fromDate) params.append('tu_ngay', this.fromDate);
                if (this.toDate) params.append('den_ngay', this.toDate);
                window.location.href = '?' + params.toString();
            },

            formatVND(value) {
                return new Intl.NumberFormat('en-US').format(value || 0) + ' ‚Ç´';
            },

            formatNumber(value) {
                if (!value) return '';
                return new Intl.NumberFormat('en-US').format(value);
            },

            getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return decodeURIComponent(value);
                    }
                }
                return '';
            },

            init() {
                console.log('Receipt manager initialized');
                console.log('Total receipts:', this.allReceipts.length);
                console.log('Approved:', this.approvedCount);
                console.log('Pending:', this.pendingCount);
                console.log('Canceled:', this.canceledCount);
            }
        }
    }
</script>
{% endblock %}