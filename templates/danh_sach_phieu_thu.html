{% extends 'base.html' %}
{% load humanize %}

{% block extra_css %}
<style>
    [x-cloak] {
        display: none !important;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .row-canceled {
        opacity: 0.5;
        background-color: #fef2f2;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen" x-data="receiptManager()" x-init="init()" x-cloak>
    <div class="w-full px-4 py-6 space-y-6">

        <!-- HEADER -->
        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-6 shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <a href="/"
                        class="text-xs font-bold text-white/80 uppercase mb-2 block hover:text-white transition">‚Üê Trang
                        ch·ªß</a>
                    <h1 class="text-3xl font-black text-white tracking-tight">üí∞ QU·∫¢N L√ù PHI·∫æU THU</h1>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 px-6 border border-white/30 min-w-[200px]">
                    <div class="text-[10px] uppercase font-black text-white/80 tracking-wider mb-1">T·ªïng thu (ƒë√£ l·ªçc)
                    </div>
                    <div class="text-3xl font-black text-white" x-text="formatVND(tongThu)"></div>
                </div>
            </div>
        </div>

        <!-- FILTER BAR -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-100 p-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üîç T√¨m ki·∫øm</label>
                    <input type="text" x-model="searchQuery"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-emerald-500 outline-none font-semibold"
                        placeholder="T√¨m kh√°ch h√†ng, m√£ phi·∫øu...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìÖ T·ª´ ng√†y</label>
                    <input type="date" x-model="fromDate"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-emerald-500 outline-none font-semibold">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìÖ ƒê·∫øn ng√†y</label>
                    <input type="date" x-model="toDate"
                        class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-emerald-500 outline-none font-semibold">
                </div>

                <div class="flex items-end gap-2">
                    <button @click="filter()"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition-all uppercase text-sm">
                        L·ªçc
                    </button>
                    <button @click="showAddModal = true"
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition-all text-lg">
                        ‚ûï
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-100 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-slate-800 to-emerald-900 text-white">
                        <tr>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üè∑Ô∏è M√£ phi·∫øu
                            </th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üìÖ Ng√†y l·∫≠p</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üë§ Kh√°ch h√†ng
                            </th>
                            <th class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider">üí∞ S·ªë ti·ªÅn</th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üí≥ H√¨nh th·ª©c
                            </th>
                            <th class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider">üìä Tr·∫°ng th√°i
                            </th>
                            <th class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider">üìù Ghi ch√∫</th>
                            <th class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider">‚öôÔ∏è Thao t√°c
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        {% for p in phieu_thu_list %}
                        <tr
                            class="hover:bg-emerald-50 transition-colors {% if p.trang_thai_duyet == 'canceled' %}row-canceled{% endif %}">
                            <td class="px-4 py-4">
                                <div class="font-bold text-emerald-600">#{{ p.maphieuthu }}</div>
                                {% if p.mahoadon %}
                                <div class="text-xs text-amber-600 mt-1">üîó Hƒê: {{ p.mahoadon }}</div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm font-semibold">{{ p.ngaylap|date:"d/m/Y" }}</div>
                                <div class="text-xs text-slate-400">{{ p.ngaylap|date:"H:i" }}</div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="font-bold text-slate-800">{{ p.khachhang.tenkhachhang }}</div>
                                {% if p.khachhang.sdt %}
                                <div class="text-xs text-slate-400">üìû {{ p.khachhang.sdt }}</div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-4 text-right">
                                <div class="text-lg font-black text-emerald-600">{{ p.sotienthu|intcomma }}‚Ç´</div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm font-semibold">{{ p.hinhthucthanhtoan }}</div>
                            </td>
                            <td class="px-4 py-4 text-center">
                                {% if p.trang_thai_duyet == 'approved' %}
                                <span
                                    class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-black uppercase">‚úì
                                    ƒê√£ duy·ªát</span>
                                {% elif p.trang_thai_duyet == 'pending' %}
                                <span
                                    class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-black uppercase">‚è≥
                                    Ch·ªù</span>
                                {% else %}
                                <span
                                    class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-black uppercase">‚úï
                                    H·ªßy</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm text-slate-600 max-w-xs truncate" title="{{ p.ghichu }}">
                                    {{ p.ghichu|default:"-" }}
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="flex items-center justify-center gap-2">
                                    {% if p.mahoadon %}
                                    <span class="text-xs text-amber-600 font-bold">üîó ƒê√≠nh k√®m Hƒê</span>
                                    {% else %}
                                    {% if p.trang_thai_duyet == 'pending' and perms.app_name.approve_phieuthu %}
                                    <form method="POST" action="{% url 'duyet_phieu_thu' p.id %}"
                                        onsubmit="return confirm('X√°c nh·∫≠n duy·ªát?')">
                                        {% csrf_token %}
                                        <button type="submit"
                                            class="p-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg transition-all hover:scale-110"
                                            title="Duy·ªát">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 13l4 4L19 7" />
                                            </svg>
                                        </button>
                                    </form>
                                    {% endif %}

                                    {% if p.trang_thai_duyet == 'pending' %}
                                    <button
                                        @click="editReceipt({{ p.id }}, {{ p.khachhang.id }}, {{ p.sotienthu }}, '{{ p.ghichu|escapejs }}', '{{ p.hinhthucthanhtoan|escapejs }}')"
                                        class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all hover:scale-110"
                                        title="S·ª≠a">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    {% endif %}

                                    <!-- ‚Üê S·ª¨A: Ch·ªâ hi·ªán n√∫t h·ªßy khi PENDING -->
                                    {% if p.trang_thai_duyet == 'pending' %}
                                    <a href="{% url 'huy_phieu_thu' p.id %}" onclick="return confirm('X√°c nh·∫≠n h·ªßy?')"
                                        class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all hover:scale-110"
                                        title="H·ªßy">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="p-24 text-center">
                                <div class="text-6xl mb-4">üí∞</div>
                                <div class="text-xl font-bold text-slate-400">Ch∆∞a c√≥ phi·∫øu thu n√†o</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT -->
    <div x-show="showAddModal" x-cloak @click.self="showAddModal = false"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">

        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl border border-slate-200" @click.stop>
            <!-- HEADER -->
            <div class="flex items-center p-6 pb-4 border-b border-slate-100">
                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tighter"
                    x-text="editingId ? '‚úèÔ∏è S·ª≠a phi·∫øu thu' : '‚ûï Th√™m phi·∫øu thu'"></h3>
                <button @click="showAddModal = false" class="ml-auto text-slate-400 hover:text-slate-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- CONTENT -->
            <form method="POST" action="{% url 'luu_phieu_thu_nhanh' %}" class="p-6 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="phieu_id" x-model="editingId">

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Kh√°ch h√†ng *</label>
                    <div class="relative">
                        <input type="text" x-model="customerSearch" @input="searchCustomersInModal()"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-emerald-500 outline-none font-bold"
                            placeholder="T√¨m t√™n ho·∫∑c SƒêT kh√°ch h√†ng..." autocomplete="off">

                        <input type="hidden" name="khachhang_id" x-model="formData.khachhang_id" required>

                        <div x-show="customerResults.length > 0"
                            class="absolute w-full left-0 top-full z-50 bg-white border-2 border-emerald-200 shadow-2xl rounded-2xl mt-2 max-h-60 overflow-y-auto"
                            @click.away="customerResults = []">
                            <template x-for="kh in customerResults" :key="kh.id">
                                <div @click="selectCustomer(kh)"
                                    class="p-3 hover:bg-emerald-50 cursor-pointer border-b flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm" x-text="kh.ten"></div>
                                        <div class="text-xs text-slate-400" x-text="kh.ma"></div>
                                    </div>
                                    <div class="text-xs text-slate-500" x-text="kh.sdt || '-'"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">S·ªë ti·ªÅn (‚Ç´) *</label>
                    <input type="text" x-model="formData.so_tien_display"
                        @input="formData.so_tien = formData.so_tien_display.replace(/,/g, '')"
                        @blur="formData.so_tien_display = formatNumber(formData.so_tien)"
                        class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-emerald-500 outline-none font-bold text-right"
                        placeholder="0">

                    <input type="hidden" name="so_tien" x-model="formData.so_tien">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">H√¨nh th·ª©c thanh to√°n</label>
                    <select name="hinh_thuc" x-model="formData.hinh_thuc"
                        class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-emerald-500 outline-none font-bold">
                        <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                        <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
                        <option value="Th·∫ª">Th·∫ª</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ghi ch√∫</label>
                    <textarea name="ghi_chu" x-model="formData.ghi_chu" rows="3"
                        class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-emerald-500 outline-none font-medium"
                        placeholder="N·ªôi dung ghi ch√∫..."></textarea>
                </div>

                <!-- FOOTER -->
                <!-- FOOTER -->
                <div class="flex gap-3 pt-4">
                    <button type="button" @click="showAddModal = false"
                        class="px-8 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-2xl transition-all uppercase text-sm">
                        H·ªßy
                    </button>

                    <!-- ‚Üê S·ª¨A: type="button" + @click + disabled -->
                    <button type="button" @click="submitForm()" :disabled="isSubmitting"
                        :class="{'opacity-50 cursor-not-allowed': isSubmitting}"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-black rounded-2xl shadow-lg transition-all uppercase text-sm">

                        <span x-show="!isSubmitting">üíæ L∆∞u phi·∫øu thu</span>
                        <span x-show="isSubmitting">‚è≥ ƒêang l∆∞u...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function receiptManager() {
        return {
            showAddModal: false,
            editingId: null,
            isSubmitting: false,
            searchQuery: '{{ search_query|default:""|escapejs }}',
            fromDate: '{{ tu_ngay|default:"" }}',
            toDate: '{{ den_ngay|default:"" }}',
            tongThu: parseFloat('{{ tong_thu|default:0 }}') || 0,
            formData: {
                khachhang_id: '',
                so_tien: '',
                so_tien_display: '',
                hinh_thuc: 'Ti·ªÅn m·∫∑t',
                ghi_chu: ''

            },
            customerSearch: '',
            customerResults: [],
            customerTimeout: null,
            searchCustomersInModal() {
                clearTimeout(this.customerTimeout);

                if (this.customerSearch.length < 2) {
                    this.customerResults = [];
                    return;
                }

                this.customerTimeout = setTimeout(async () => {
                    try {
                        const res = await fetch(`/api/search-customers/?q=${encodeURIComponent(this.customerSearch)}`);
                        this.customerResults = await res.json();
                    } catch (e) {
                        console.error('Search error:', e);
                        this.customerResults = [];
                    }
                }, 300);
            },
            async submitForm() {
                if (this.isSubmitting) {
                    console.log('ƒêang submit, b·ªè qua');
                    return;
                }

                // Validate
                if (!this.formData.khachhang_id) {
                    alert("‚ùå Vui l√≤ng ch·ªçn kh√°ch h√†ng!");
                    return;
                }

                if (!this.formData.so_tien || parseFloat(this.formData.so_tien) <= 0) {
                    alert("‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn!");
                    return;
                }

                this.isSubmitting = true;

                try {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', this.getCSRFToken());
                    formData.append('khachhang_id', this.formData.khachhang_id);
                    formData.append('so_tien', this.formData.so_tien);
                    formData.append('hinh_thuc', this.formData.hinh_thuc);
                    formData.append('ghi_chu', this.formData.ghi_chu);

                    if (this.editingId) {
                        formData.append('phieu_id', this.editingId);
                    }

                    const response = await fetch('{% url "luu_phieu_thu_nhanh" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        alert(result.message);
                        this.showAddModal = false;
                        window.location.reload();
                    } else {
                        alert(result.message || '‚ùå C√≥ l·ªói x·∫£y ra');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    alert('‚ùå L·ªói k·∫øt n·ªëi!');
                } finally {
                    this.isSubmitting = false;
                }
            },
            selectCustomer(kh) {
                this.formData.khachhang_id = kh.id;
                this.customerSearch = kh.ten;
                this.customerResults = [];
            },
            editReceipt(id, khId, soTien, ghiChu, hinhThuc) {
                this.editingId = id;
                this.formData = {
                    khachhang_id: khId,
                    so_tien: soTien,
                    so_tien_display: this.formatNumber(soTien),  // ‚Üê TH√äM
                    hinh_thuc: hinhThuc || 'Ti·ªÅn m·∫∑t',
                    ghi_chu: ghiChu || ''
                };
                this.customerSearch = '';
                this.showAddModal = true;
            },
            init() {
                console.log('Receipt manager initialized');
            },
            getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return decodeURIComponent(value);
                    }
                }
                return '';
            },
            filter() {
                const params = new URLSearchParams();
                if (this.searchQuery) params.append('search', this.searchQuery);
                if (this.fromDate) params.append('tu_ngay', this.fromDate);
                if (this.toDate) params.append('den_ngay', this.toDate);
                window.location.href = '?' + params.toString();
            },

            editReceipt(id, khId, soTien, ghiChu, hinhThuc) {
                this.editingId = id;
                this.formData = {
                    khachhang_id: khId,
                    so_tien: soTien,
                    hinh_thuc: hinhThuc || 'Ti·ªÅn m·∫∑t',
                    ghi_chu: ghiChu || ''
                };
                this.showAddModal = true;
            },

            formatVND(value) {
                return new Intl.NumberFormat('en-US').format(value || 0) + ' ‚Ç´';
            },
            formatNumber(value) {
                if (!value) return '';
                return new Intl.NumberFormat('en-US').format(value);
            },
        }
    }
</script>
{% endblock %}