<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω Kh√°ch H√†ng | Gemini POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        [x-cloak] {
            display: none !important;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen" x-data="customerManager()" x-init="init()" x-cloak>
    <nav class="bg-purple-600 p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center text-white">
            <h1 class="text-xl font-black uppercase">üë• Qu·∫£n L√Ω Kh√°ch H√†ng</h1>
            <div class="text-sm font-semibold">Gemini POS 2026</div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 space-y-6">
        <div class="bg-white rounded-xl shadow p-4 flex gap-4 items-center">
            <input type="text" x-model="searchQuery" placeholder="T√¨m t√™n, SƒêT, m√£ kh√°ch..."
                class="flex-1 border rounded-lg px-4 py-2 outline-none focus:ring-2 ring-purple-500">

            <select x-model="filterType" class="border rounded-lg px-4 py-2 outline-none">
                <option value="all">T·∫•t c·∫£ ph√¢n lo·∫°i</option>
                <option value="LE">Kh√°ch l·∫ª</option>
                <option value="SI">Kh√°ch s·ªâ</option>
            </select>

            <button @click="showAddModal = true"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 transition shadow-md">
                <span class="text-xl">+</span> Th√™m kh√°ch h√†ng
            </button>
        </div>
        <div class="bg-white rounded-xl shadow p-4 flex gap-4">
            <input type="text" x-model="searchQuery" placeholder="T√¨m t√™n, SƒêT, m√£ kh√°ch..."
                class="flex-1 border rounded-lg px-4 py-2 outline-none focus:ring-2 ring-purple-500">
            <select x-model="filterType" class="border rounded-lg px-4 py-2">
                <option value="all">T·∫•t c·∫£</option>
                <option value="LE">Kh√°ch l·∫ª</option>
                <option value="SI">Kh√°ch s·ªâ</option>
            </select>
        </div>

        <div class="bg-white rounded-xl shadow overflow-hidden">
            <table class="w-full">
                <thead class="bg-slate-800 text-white text-xs uppercase">
                    <tr>
                        <th class="p-4 text-left">M√£ KH</th>
                        <th class="p-4 text-left">T√™n kh√°ch h√†ng</th>
                        <th class="p-4 text-left">SƒêT</th>
                        <th class="p-4 text-right">D∆∞ n·ª£ hi·ªán t·∫°i</th>
                        <th class="p-4 text-center">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    <template x-for="c in filteredCustomers" :key="c.id">
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-4 font-bold text-purple-600" x-text="c.ma"></td>
                            <td class="p-4 font-bold" x-text="c.ten"></td>
                            <td class="p-4" x-text="c.sdt || '-'"></td>
                            <td class="p-4 text-right font-black text-red-600" x-text="formatVND(c.du_no)"></td>
                            <td class="p-4 text-center">
                                <button @click="openView(c.id)"
                                    class="bg-blue-600 text-white px-4 py-1.5 rounded-lg hover:bg-blue-700 font-bold">Chi
                                    ti·∫øt</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    <div x-show="showAddModal" class="fixed inset-0 z-[110] flex items-center justify-center p-4" x-cloak>
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showAddModal = false"></div>

        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl z-10 overflow-hidden">
            <div class="p-4 border-b bg-green-50 flex justify-between items-center">
                <h2 class="text-lg font-black text-green-800 uppercase tracking-tight">üÜï Th√™m kh√°ch h√†ng m·ªõi</h2>
                <button @click="showAddModal = false"
                    class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <form @submit.prevent="saveCustomer" class="p-6 grid grid-cols-2 gap-4">
                <div class="col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">M√£ kh√°ch h√†ng (ƒê·ªÉ tr·ªëng s·∫Ω t·ª±
                        t·∫°o)</label>
                    <input type="text" x-model="newCust.makhachhang"
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 ring-green-500 outline-none">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">T√™n kh√°ch h√†ng *</label>
                    <input type="text" x-model="newCust.tenkhachhang" required
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 ring-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" x-model="newCust.sdt" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ph√¢n lo·∫°i</label>
                    <select x-model="newCust.phanloai" class="w-full border rounded-lg px-3 py-2">
                        <option value="LE">Kh√°ch l·∫ª</option>
                        <option value="SI">Kh√°ch s·ªâ</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ƒê·ªãa ch·ªâ</label>
                    <input type="text" x-model="newCust.diachi" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="col-span-2 flex justify-end gap-3 mt-4">
                    <button type="button" @click="showAddModal = false"
                        class="px-6 py-2 font-bold text-slate-500">H·ªßy</button>
                    <button type="submit"
                        class="bg-green-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-green-700 shadow-lg transition">L∆∞u
                        kh√°ch h√†ng</button>
                </div>
            </form>
        </div>
    </div>
    <div x-show="showModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4" x-cloak>
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" @click="showModal = false"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden z-10 flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="bg-purple-600 text-white px-3 py-1 rounded-lg font-bold text-sm"
                        x-text="customer.ma"></span>
                    <h2 class="text-xl font-black text-slate-800 uppercase" x-text="customer.ten"></h2>
                </div>
                <button @click="showModal = false" class="text-slate-400 hover:text-red-500 text-3xl">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-white">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <div
                        class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6 border p-5 rounded-2xl bg-slate-50/50">
                        <div class="md:col-span-3 border-b pb-2"><span
                                class="text-xs font-black text-purple-700 uppercase">üìÑ Th√¥ng tin h√†nh ch√≠nh</span>
                        </div>
                        <div><label class="block text-[10px] text-slate-400 font-bold">SƒêT</label>
                            <p class="font-bold" x-text="customer.sdt || '---'"></p>
                        </div>
                        <div><label class="block text-[10px] text-slate-400 font-bold">M√£ s·ªë thu·∫ø</label>
                            <p class="font-bold" x-text="customer.mst || '---'"></p>
                        </div>
                        <div><label class="block text-[10px] text-slate-400 font-bold">Email</label>
                            <p class="font-bold" x-text="customer.email || '---'"></p>
                        </div>
                        <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 font-bold">ƒê·ªãa
                                ch·ªâ</label>
                            <p x-text="customer.diachi || '---'"></p>
                        </div>
                        <div><label class="block text-[10px] text-slate-400 font-bold">Ph√¢n lo·∫°i</label>
                            <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase bg-blue-100 text-blue-700"
                                x-text="customer.phan_loai === 'SI' ? 'Kh√°ch S·ªâ' : 'Kh√°ch L·∫ª'"></span>
                        </div>
                    </div>
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-xl">
                        <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">D∆∞ n·ª£ hi·ªán t·∫°i</label>
                        <p class="text-3xl font-black text-red-400" x-text="formatVND(customer.du_no)"></p>
                        <div class="mt-4 pt-4 border-t border-slate-700 text-xs space-y-2">
                            <div class="flex justify-between"><span>N·ª£ ƒë·∫ßu k·ª≥:</span><span
                                    x-text="formatVND(customer.no_dau_ky)"></span></div>
                        </div>
                    </div>
                </div>

                <div x-data="{ tab: 'socai' }">
                    <div class="flex gap-1 bg-slate-100 p-1 rounded-xl mb-4 w-fit">
                        <button @click="tab = 'socai'"
                            :class="tab === 'socai' ? 'bg-white shadow text-purple-600' : 'text-slate-500'"
                            class="px-6 py-2 rounded-lg font-bold text-sm transition">üìí S·ªï c√°i c√¥ng n·ª£</button>
                        <button @click="tab = 'phieuthu'"
                            :class="tab === 'phieuthu' ? 'bg-white shadow text-purple-600' : 'text-slate-500'"
                            class="px-6 py-2 rounded-lg font-bold text-sm transition">üí∞ L·ªãch s·ª≠ thu ti·ªÅn</button>
                    </div>

                    <div x-show="tab === 'socai'">
                        <table class="w-full text-sm border rounded-xl overflow-hidden">
                            <thead class="bg-slate-800 text-white text-[11px] uppercase">
                                <tr>
                                    <th class="p-3">Ng√†y</th>
                                    <th class="p-3">Ch·ª©ng t·ª´</th>
                                    <th class="p-3">Di·ªÖn gi·∫£i</th>
                                    <th class="p-3 text-right">TƒÉng</th>
                                    <th class="p-3 text-right">Gi·∫£m</th>
                                    <th class="p-3 text-right">D∆∞ n·ª£</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <template x-for="entry in entries" :key="entry.id">
                                    <tr>
                                        <td class="p-3 text-slate-500" x-text="entry.ngay_ghi_so"></td>
                                        <td class="p-3 font-bold uppercase" x-text="entry.ma_chung_tu"></td>
                                        <td class="p-3" x-text="entry.dien_giai"></td>
                                        <td class="p-3 text-right text-red-600 font-bold"
                                            x-text="entry.tang > 0 ? formatVND(entry.tang) : '-'"></td>
                                        <td class="p-3 text-right text-green-600 font-bold"
                                            x-text="entry.giam > 0 ? formatVND(entry.giam) : '-'"></td>
                                        <td class="p-3 text-right font-black" x-text="formatVND(entry.du_no_tuc_thoi)">
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function customerManager() {
            return {
                customers: [], searchQuery: '', filterType: 'all', showModal: false,
                customer: {}, entries: [], receipts: [],
                init() { this.loadCustomers(); },
                showAddModal: false,
                newCust: {
                    makhachhang: '',
                    tenkhachhang: '',
                    sdt: '',
                    phanloai: 'LE',
                    diachi: ''
                },
                async saveCustomer() {
                    try {
                        const response = await fetch('/api/add-customer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify(this.newCust)
                        });

                        if (response.ok) {
                            alert('Th√™m kh√°ch h√†ng th√†nh c√¥ng!');
                            this.showAddModal = false;
                            this.loadCustomers(); // T·∫£i l·∫°i danh s√°ch
                            this.newCust = { makhachhang: '', tenkhachhang: '', sdt: '', phanloai: 'LE', diachi: '' };
                        } else {
                            const err = await response.json();
                            alert('L·ªói: ' + (err.message || 'Kh√¥ng th·ªÉ l∆∞u'));
                        }
                    } catch (e) {
                        alert('L·ªói k·∫øt n·ªëi Server');
                    }
                },
                async loadCustomers() {
                    const res = await fetch('/api/get-customers/');
                    this.customers = await res.json();
                },
                get filteredCustomers() {
                    return this.customers.filter(c => {
                        const s = this.searchQuery.toLowerCase();
                        return (!this.searchQuery || c.ten.toLowerCase().includes(s) || c.ma.toLowerCase().includes(s)) && (this.filterType === 'all' || c.phan_loai === this.filterType);
                    });
                },
                async openView(id) {
                    this.showModal = true;
                    const res = await fetch(`/api/customer-detail/${id}/`);
                    const data = await res.json();
                    this.customer = data.customer;
                    this.entries = data.entries;
                    this.receipts = data.receipts;
                },
                formatVND(v) { return new Intl.NumberFormat('vi-VN').format(v || 0) + ' ‚Ç´'; }
            }
        }
    </script>
</body>

</html>