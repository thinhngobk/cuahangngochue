{% extends 'base.html' %}
{% load static %}

{% block title %}Qu·∫£n L√Ω Kh√°ch H√†ng | Gemini POS{% endblock %}

{% block content %}
{% csrf_token %}

<div class="bg-slate-50 min-h-screen" x-data="customerManager()" x-init="init()" x-cloak>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>

    <div class="w-full px-4 py-6 space-y-6">
        <!-- HEADER -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 mb-6 shadow-lg">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-black text-white tracking-tight">üë• QU·∫¢N L√ù KH√ÅCH H√ÄNG</h1>
                <div class="text-white text-lg font-semibold">
                    T·ªïng: <span class="font-black text-2xl" x-text="customers.length"></span> kh√°ch h√†ng
                </div>
            </div>
        </div>

        <!-- SEARCH & FILTER BAR -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-purple-200 p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üîç T√¨m ki·∫øm</label>
                    <input type="text" x-model="searchQuery"
                        class="w-full px-4 py-3 border-2 border-purple-100 rounded-xl focus:border-purple-500 outline-none font-semibold"
                        placeholder="T√™n kh√°ch h√†ng, m√£, SƒêT...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìä Ph√¢n lo·∫°i</label>
                    <select x-model="filterType"
                        class="w-full px-4 py-3 border-2 border-purple-100 rounded-xl focus:border-purple-500 outline-none font-semibold">
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="LE">Kh√°ch l·∫ª</option>
                        <option value="SI">Kh√°ch s·ªâ</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button @click="showAddModal = true" type="button"
                        class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 uppercase text-sm">
                        <span>‚ûï Th√™m m·ªõi</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS TABLE -->
        <div class="bg-white rounded-2xl shadow-lg border-2 border-purple-200 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-slate-800 to-purple-900 text-white">
                        <tr>
                            <th
                                class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üè∑Ô∏è M√£ KH</th>
                            <th
                                class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üë§ T√™n kh√°ch h√†ng</th>
                            <th
                                class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider whitespace-nowrap hidden">
                                üìç ƒê·ªãa ch·ªâ</th>
                            <th
                                class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üìû SƒêT</th>
                            <th
                                class="px-3 py-3 text-left text-xs font-black uppercase tracking-wider whitespace-nowrap hidden">
                                üìß Email</th>
                            <th
                                class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üè™ Ph√¢n lo·∫°i</th>
                            <th
                                class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider whitespace-nowrap hidden">
                                üí∞ N·ª£ ƒë·∫ßu k·ª≥</th>
                            <th
                                class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üìä D∆∞ n·ª£ cu·ªëi k·ª≥</th>
                            <th
                                class="px-4 py-4 text-right text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üéØ H·∫°n m·ª©c n·ª£</th>
                            <th
                                class="px-4 py-4 text-left text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                üìù Ghi ch√∫</th>
                            <th
                                class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                ‚úÖ Tr·∫°ng th√°i
                            </th>
                            <th
                                class="px-4 py-4 text-center text-xs font-black uppercase tracking-wider whitespace-nowrap">
                                ‚öôÔ∏è Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                        <template x-for="c in filteredCustomers" :key="c.id">
                            <tr class="hover:bg-purple-50 transition-colors duration-150">
                                <td class="px-4 py-4">
                                    <div class="font-bold text-purple-600" x-text="c.ma"></div>
                                </td>
                                
                                <td class="px-4 py-4">
                                    <div class="font-bold text-slate-800" x-text="c.ten"></div>
                                </td>
                                <td class="px-4 py-4 hidden">
                                    <div class="text-sm text-slate-600 max-w-[120px] truncate" x-text="c.diachi || '-' "
                                        :title="c.diachi || ''"></div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="font-mono text-sm" x-text="c.sdt || '-'"></div>
                                </td>
                                <td class="px-3 py-3 hidden">
                                    <div class="text-sm text-slate-600" x-text="c.email || '-'"></div>
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <span class="px-3 py-1 rounded-full text-xs font-black uppercase whitespace-nowrap"
                                        :class="c.phan_loai === 'SI' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'"
                                        x-text="c.phan_loai === 'SI' ? 'S·ªâ' : 'L·∫ª'"></span>
                                </td>
                                <td class="px-4 py-4 text-right hidden">
                                    <div class="font-bold text-slate-600" x-text="formatVND(c.no_dau_ky)"></div>
                                </td>
                                <td class="px-4 py-4 text-right">
                                    <div class="font-black text-lg"
                                        :class="c.du_no > 0 ? 'text-red-600' : 'text-green-600'"
                                        x-text="formatVND(c.du_no)"></div>
                                </td>
                                <td class="px-4 py-4 text-right">
                                    <div class="font-bold text-orange-600" x-text="formatVND(c.han_muc_no)"></div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-sm text-slate-500 max-w-[100px] truncate" x-text="c.ghichu || '-'"
                                        :title="c.ghichu || ''"></div>
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <button @click="toggleActive(c)" type="button"
                                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                                        :class="c.is_active ? 'bg-green-500' : 'bg-gray-300'">
                                        <span
                                            class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                                            :class="c.is_active ? 'translate-x-6' : 'translate-x-1'">
                                        </span>
                                    </button>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="flex items-center justify-center gap-2">
                                        <button @click="editCustomer(c)"
                                            class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all hover:scale-110"
                                            title="S·ª≠a th√¥ng tin">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button @click="openView(c.id)"
                                            class="p-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-all hover:scale-110"
                                            title="Xem chi ti·∫øt">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>

                <template x-if="filteredCustomers.length === 0">
                    <div class="p-24 text-center">
                        <div class="text-6xl mb-4">üë•</div>
                        <div class="text-xl font-bold text-slate-400">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng</div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT CUSTOMER -->
    <div x-show="showAddModal" x-cloak @click.self="showAddModal = false"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">

        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-4xl border border-slate-200 max-h-[90vh] flex flex-col"
            @click.stop>

            <!-- HEADER -->
            <div class="flex items-center p-6 pb-4 border-b border-slate-100 shrink-0">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tighter"
                    x-text="editingCustomer ? '‚úèÔ∏è Ch·ªânh s·ª≠a kh√°ch h√†ng' : '‚ûï Th√™m kh√°ch h√†ng m·ªõi'"></h3>
                <button @click="showAddModal = false" class="ml-auto text-slate-400 hover:text-slate-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- CONTENT -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Row 1: M√£ KH (readonly khi edit) + T√™n KH -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">M√£ kh√°ch h√†ng</label>
                        <input type="text" x-model="formData.ma" :readonly="editingCustomer"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold"
                            :class="editingCustomer ? 'bg-slate-50 cursor-not-allowed' : ''"
                            placeholder="ƒê·ªÉ tr·ªëng t·ª± ƒë·ªông t·∫°o">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">T√™n kh√°ch h√†ng *</label>
                        <input type="text" x-model="formData.ten" required
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold"
                            placeholder="Nh·∫≠p t√™n kh√°ch h√†ng...">
                    </div>

                    <!-- Row 2: SƒêT + Email -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" x-model="formData.sdt"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold"
                            placeholder="0xxxxxxxxx">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Email</label>
                        <input type="email" x-model="formData.email"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold"
                            placeholder="email@example.com">
                    </div>

                    <!-- Row 3: ƒê·ªãa ch·ªâ (full width) -->
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ƒê·ªãa ch·ªâ</label>
                        <input type="text" x-model="formData.diachi"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold"
                            placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/TP">
                    </div>

                    <!-- Row 4: MST + Ph√¢n lo·∫°i -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">M√£ s·ªë thu·∫ø</label>
                        <input type="text" x-model="formData.mst"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold"
                            placeholder="M√£ s·ªë thu·∫ø (n·∫øu c√≥)">
                    </div>
                    <!-- Row 5: N·ª£ ƒë·∫ßu k·ª≥ + H·∫°n m·ª©c n·ª£ (readonly khi edit) -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">N·ª£ ƒë·∫ßu k·ª≥ (‚Ç´)</label>
                        <input type="number" x-model="formData.no_dau_ky" :readonly="editingCustomer"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold text-right"
                            :class="editingCustomer ? 'bg-slate-50 cursor-not-allowed' : ''" placeholder="0">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">H·∫°n m·ª©c n·ª£ (‚Ç´)</label>
                        <input type="number" x-model="formData.han_muc_no" :readonly="editingCustomer"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold text-right"
                            :class="editingCustomer ? 'bg-slate-50 cursor-not-allowed' : ''" placeholder="0">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ph√¢n lo·∫°i</label>
                        <select x-model="formData.phanloai"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-bold">
                            <option value="LE">Kh√°ch l·∫ª</option>
                            <option value="SI">Kh√°ch s·ªâ</option>
                        </select>
                    </div>

                    <!-- Row 5: Ghi ch√∫ (full width) -->
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ghi ch√∫</label>
                        <textarea x-model="formData.ghichu" rows="3"
                            class="w-full p-3 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-medium"
                            placeholder="Th√¥ng tin th√™m v·ªÅ kh√°ch h√†ng..."></textarea>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="flex gap-3 p-6 pt-4 border-t border-slate-100 shrink-0">
                <button @click="showAddModal = false"
                    class="px-8 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-2xl transition-all uppercase text-sm">
                    H·ªßy
                </button>
                <button @click="saveCustomer"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-black rounded-2xl shadow-lg transition-all uppercase text-sm">
                    üíæ <span x-text="editingCustomer ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: VIEW DETAIL -->
    <div x-show="showModal" x-cloak @click.self="showModal = false"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <span class="bg-purple-600 text-white px-3 py-1 rounded-lg font-bold text-sm"
                        x-text="customer.ma"></span>
                    <h2 class="text-xl font-black text-slate-800 uppercase" x-text="customer.ten"></h2>
                </div>
                <button @click="showModal = false" class="text-slate-400 hover:text-red-500 text-3xl">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-white custom-scrollbar">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <div
                        class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6 border p-5 rounded-2xl bg-slate-50/50">
                        <div class="md:col-span-3 border-b pb-2">
                            <span class="text-xs font-black text-purple-700 uppercase">üìÑ Th√¥ng tin h√†nh ch√≠nh</span>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold">SƒêT</label>
                            <p class="font-bold" x-text="customer.sdt || '---'"></p>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold">M√£ s·ªë thu·∫ø</label>
                            <p class="font-bold" x-text="customer.mst || '---'"></p>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold">Email</label>
                            <p class="font-bold" x-text="customer.email || '---'"></p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] text-slate-400 font-bold">ƒê·ªãa ch·ªâ</label>
                            <p x-text="customer.diachi || '---'"></p>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 font-bold">Ph√¢n lo·∫°i</label>
                            <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase bg-blue-100 text-blue-700"
                                x-text="customer.phan_loai === 'SI' ? 'Kh√°ch S·ªâ' : 'Kh√°ch L·∫ª'"></span>
                        </div>
                    </div>
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-xl">
                        <label class="block text-[10px] text-slate-400 font-bold uppercase mb-2">D∆∞ n·ª£ hi·ªán t·∫°i</label>
                        <p class="text-3xl font-black text-red-400" x-text="formatVND(customer.du_no)"></p>
                        <div class="mt-4 pt-4 border-t border-slate-700 text-xs space-y-2">
                            <div class="flex justify-between">
                                <span>N·ª£ ƒë·∫ßu k·ª≥:</span>
                                <span x-text="formatVND(customer.no_dau_ky)"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-data="{ tab: 'socai' }">
                    <div class="flex gap-1 bg-slate-100 p-1 rounded-xl mb-4 w-fit">
                        <button @click="tab = 'socai'"
                            :class="tab === 'socai' ? 'bg-white shadow text-purple-600' : 'text-slate-500'"
                            class="px-6 py-2 rounded-lg font-bold text-sm transition">üìí S·ªï c√°i c√¥ng n·ª£</button>
                        <button @click="tab = 'phieuthu'"
                            :class="tab === 'phieuthu' ? 'bg-white shadow text-purple-600' : 'text-slate-500'"
                            class="px-6 py-2 rounded-lg font-bold text-sm transition">üí∞ L·ªãch s·ª≠ thu ti·ªÅn</button>
                    </div>

                    <div x-show="tab === 'socai'">
                        <table class="w-full text-sm border rounded-xl overflow-hidden">
                            <thead class="bg-slate-800 text-white text-[11px] uppercase">
                                <tr>
                                    <th class="p-3">Ng√†y</th>
                                    <th class="p-3">Ch·ª©ng t·ª´</th>
                                    <th class="p-3">Di·ªÖn gi·∫£i</th>
                                    <th class="p-3 text-right">TƒÉng</th>
                                    <th class="p-3 text-right">Gi·∫£m</th>
                                    <th class="p-3 text-right">D∆∞ n·ª£</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <template x-for="entry in entries" :key="entry.id">
                                    <tr>
                                        <td class="p-3 text-slate-500" x-text="entry.ngay_ghi_so"></td>
                                        <td class="p-3 font-bold uppercase" x-text="entry.ma_chung_tu"></td>
                                        <td class="p-3" x-text="entry.dien_giai"></td>
                                        <td class="p-3 text-right text-red-600 font-bold"
                                            x-text="entry.tang > 0 ? formatVND(entry.tang) : '-'"></td>
                                        <td class="p-3 text-right text-green-600 font-bold"
                                            x-text="entry.giam > 0 ? formatVND(entry.giam) : '-'"></td>
                                        <td class="p-3 text-right font-black" x-text="formatVND(entry.du_no_tuc_thoi)">
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function customerManager() {
        return {
            customers: [],
            searchQuery: '',
            filterType: 'all',
            showModal: false,
            showAddModal: false,
            editingCustomer: null,
            customer: {},
            entries: [],
            receipts: [],
            formData: {
                ma: '',
                ten: '',
                sdt: '',
                email: '',
                diachi: '',
                mst: '',
                phanloai: 'LE',
                no_dau_ky: 0,    // ‚Üê TH√äM
                han_muc_no: 0,
                ghichu: ''
            },

            init() {
                this.loadCustomers();
            },

            resetForm() {
                this.formData = {
                    ma: '',
                    ten: '',
                    sdt: '',
                    email: '',
                    diachi: '',
                    mst: '',
                    phanloai: 'LE',
                    no_dau_ky: 0,    // ‚Üê TH√äM
                    han_muc_no: 0,
                    ghichu: ''
                };
            },
            async toggleActive(customer) {
                const newStatus = !customer.is_active;
                const action = newStatus ? 'k√≠ch ho·∫°t' : 't·∫°m ng∆∞ng';

                if (!confirm(`X√°c nh·∫≠n ${action} kh√°ch h√†ng ${customer.ten}?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/toggle-customer-active/${customer.id}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            is_active: newStatus
                        })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        // C·∫≠p nh·∫≠t local
                        customer.is_active = newStatus;
                        alert(`ƒê√£ ${action} kh√°ch h√†ng!`);
                    } else {
                        alert('L·ªói: ' + result.message);
                    }
                } catch (e) {
                    alert('L·ªói k·∫øt n·ªëi: ' + e.message);
                }
            },
            editCustomer(customer) {
                this.editingCustomer = customer;
                this.formData = {
                    ma: customer.ma,
                    ten: customer.ten,
                    sdt: customer.sdt || '',
                    email: customer.email || '',
                    diachi: customer.diachi || '',
                    mst: customer.mst || '',
                    phanloai: customer.phan_loai,
                    no_dau_ky: 0,    // ‚Üê TH√äM
                    han_muc_no: 0,
                    ghichu: customer.ghichu || ''
                };
                this.showAddModal = true;
            },

            async saveCustomer() {
                if (!this.formData.ten.trim()) {
                    return alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!');
                }

                try {
                    const url = this.editingCustomer
                        ? `/api/update-customer/${this.editingCustomer.id}/`
                        : '/add_customer_fast/';

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(this.formData)
                    });

                    const result = await response.json();
                    if (result.status === 'success' || response.ok) {
                        alert(this.editingCustomer ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m kh√°ch h√†ng th√†nh c√¥ng!');
                        this.showAddModal = false;
                        this.editingCustomer = null;
                        this.resetForm();
                        this.loadCustomers();
                    } else {
                        alert('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u'));
                    }
                } catch (e) {
                    alert('L·ªói k·∫øt n·ªëi Server: ' + e.message);
                }
            },

            async loadCustomers() {
                const res = await fetch('/api/get-customers/');
                this.customers = await res.json();
            },

            get filteredCustomers() {
                return this.customers.filter(c => {
                    const s = this.searchQuery.toLowerCase();
                    const matchSearch = !this.searchQuery ||
                        c.ten.toLowerCase().includes(s) ||
                        c.ma.toLowerCase().includes(s) ||
                        (c.sdt && c.sdt.includes(s));
                    const matchType = this.filterType === 'all' || c.phan_loai === this.filterType;
                    return matchSearch && matchType;
                });
            },

            async openView(id) {
                this.showModal = true;
                const res = await fetch(`/api/customer-detail/${id}/`);
                const data = await res.json();
                this.customer = data.customer;
                this.entries = data.entries;
                this.receipts = data.receipts;
            },

            formatVND(v) {
                return new Intl.NumberFormat('en-US').format(v || 0) + ' ‚Ç´';
            }
        }
    }
</script>
{% endblock %}